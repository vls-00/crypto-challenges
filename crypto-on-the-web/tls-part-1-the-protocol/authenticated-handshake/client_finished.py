import hmac
import hashlib
import struct

from math import ceil


HASH_ALG = hashlib.sha384
HASH_LEN = HASH_ALG().digest_size


def tls_HMAC(k, b, algorithm):
    return bytearray(hmac.new(k, b, algorithm).digest())


def HKDF_expand(prk, info, length, algorithm):
    hash_len = algorithm().digest_size
    t = bytearray()
    okm = bytearray()
    for i in range(1, ceil(length / hash_len)+2):
        t = tls_HMAC(prk, t + info + bytearray([i]), algorithm)
        okm += t
    return okm[:length]


def HKDF_expand_label(secret, label, hashValue, length, algorithm):
    hkdfLabel = bytearray()
    hkdfLabel += struct.pack('>H', length)
    seq = bytearray(b"tls13 ") + label
    hkdfLabel += bytearray([len(seq)]) + seq
    seq = hashValue
    hkdfLabel += bytearray([len(seq)]) + seq

    return HKDF_expand(secret, hkdfLabel, length, algorithm)


def verify_data(finished_key, transcript, hash_alg):
    transcript_hash = hash_alg(transcript).digest()
    return tls_HMAC(finished_key, transcript_hash, hash_alg)


client_hello = bytes.fromhex("""
010001fc0303d8c7c79e62892bd09bafe063b1f948880855589ef13eb847ca27e8436aa6ad8020e9319bcbc7a532d08e0aa9597740d8467a3452ad54693c6004d5e7e43fa37cd800b6130213031301c02cc03000a3009fcca9cca8ccaac0afc0adc0a3c09fc05dc061c057c05300a7c02bc02f00a2009ec0aec0acc0a2c09ec05cc060c056c05200a6c024c028006b006ac073c07700c400c3006d00c5c023c02700670040c072c07600be00bd006c00bfc00ac0140039003800880087c019003a0089c009c01300330032009a009900450044c0180034009b0046009dc0a1c09dc051009cc0a0c09cc050003d00c0003c00ba00350084002f0096004100ff010000fd000000180016000013746c73332e63727970746f6861636b2e6f7267000b000403000102000a00160014001d0017001e0019001801000101010201030104337400000010000e000c02683208687474702f312e31001600000017000000310000000d0030002e040305030603080708080809080a080b080408050806040105010601030302030301020103020202040205020602002b0009080304030303020301002d00020101003300260024001d0020f54b4d2a777319ad3dc6cd8239025f24b547cce209feb5b60aeaec25cb63af1b0015002800000000000000000000000000000000000000000000000000000000000000000000000000000000
        """)

server_hello = bytes.fromhex("""
0200007603032ce8accef17501fe4fc76ef5184fc43ac9c42b49138de575cf26fd46575488f420e9319bcbc7a532d08e0aa9597740d8467a3452ad54693c6004d5e7e43fa37cd8130200002e002b0002030400330024001d0020ead5ed6ad655b389fa0e5a2b765cf2ca78ea4d6a8137f51d590432dcf610891e
        """)

server_encrypted_extensions = bytes.fromhex("""
0800000f000d00000000001000050003026832
        """)

server_certificate_message = bytes.fromhex("""
0b000fc100000fbd0005303082052c30820414a003020102021204d103c998b027fd2a4ffecc1256f0a89d5f300d06092a864886f70d01010b05003032310b300906035504061302555331163014060355040a130d4c6574277320456e6372797074310b3009060355040313025233301e170d3232313230323032333930365a170d3233303330323032333930355a301e311c301a06035504031313746c73332e63727970746f6861636b2e6f726730820122300d06092a864886f70d01010105000382010f003082010a0282010100ad3afff370d54ef82af74ff23665fd87440b4826ac9f0405f868f1a5bf0fd7678e45fdda9f8450a7b2b1fccb088e4f9f6dc2d915d3e3caf3d7f93b328a39aec0e4d7b37a526797258d74044077b1987cc64b21f00c4570fcb23eb847a9ef8e4550581723f086d1f2aaaa4922e57455a244b47de1bb8564b450cf4aa2a435a3f9fcc9e92e8fc7480810e0675c95c2cc3d4f91b109694d73e333ae6eee28ebba7f0241b56ad9216799d78f1c79cd9861c6d5a325bc65a9bf7eabb83096d43959ed711d1e47a56217f3b3d6c2851bf8dd52b1be765eb5bff20d309bec29373cd82e56445774dae5caa53e86db225bb6f670e232fc728d8d5816a1e58398bd49f7ff0203010001a382024e3082024a300e0603551d0f0101ff0404030205a0301d0603551d250416301406082b0601050507030106082b06010505070302300c0603551d130101ff04023000301d0603551d0e04160414714821416a3c5cd26ce224e5159fa31556f47bfd301f0603551d23041830168014142eb317b75856cbae500940e61faf9d8b14c2c6305506082b0601050507010104493047302106082b060105050730018615687474703a2f2f72332e6f2e6c656e63722e6f7267302206082b060105050730028616687474703a2f2f72332e692e6c656e63722e6f72672f301e0603551d11041730158213746c73332e63727970746f6861636b2e6f7267304c0603551d20044530433008060667810c0102013037060b2b0601040182df130101013028302606082b06010505070201161a687474703a2f2f6370732e6c657473656e63727970742e6f726730820104060a2b06010401d6790204020481f50481f200f0007600adf7befa7cff10c88b9d3d9c1e3e186ab467295dcfb10c24ca858634ebdc828a00000184d0ea99bc0000040300473045022100aa2317fba674bc52e57f8b19928495b93ed456dd8c2a1ec6e616e521fb34171a0220017dcb944de4e45e038a0129110f6d77607b2cb41d146bb0969ec907cb02d139007600b73efb24df9c4dba75f239c5ba58f46c5dfc42cf7a9f35c49e1d098125edb49900000184d0ea9b120000040300473045022038a6107abe9d1a39a9190f3b9ede5de3fbd17b1ff80330706c47beec35dca51c02210094b59fa61a681508f9a485572580e1d052ff3592372ff34da13e1b742889f67b300d06092a864886f70d01010b0500038201010061e86f522bdda3da6dbee01ecd18772c48a532b5e9805797eb059516d85760833fe499ae50d8f218ba7613160e7111f183f25d0ba67d9967ea3b3b5a048afe4cff39cdc975b3eb96f13293e330ac08cfa796d5f41f466ea91226c5f0e951f8b2c332d43c10270db3d8e83e2a07c54bf90c4b6e1e29448771de53b5a0542064a2868f0ed4afb53cca419dc183d08ede4bcd3016ee47b888da2f1df955c26ce935d27771aef9d42e051d244576379ff0ec7b4efb825aa6efc554396faf2506598dfb5771857110b12ce8f4d3f17a3845612b7f27036a1e21752f6fda79675956c804b6b8b780dda78cdbc078a053345ed1f20502998962d8ed47bf154fbc021d5a000000051a30820516308202fea003020102021100912b084acf0c18a753f6d62e25a75f5a300d06092a864886f70d01010b0500304f310b300906035504061302555331293027060355040a1320496e7465726e65742053656375726974792052657365617263682047726f7570311530130603550403130c4953524720526f6f74205831301e170d3230303930343030303030305a170d3235303931353136303030305a3032310b300906035504061302555331163014060355040a130d4c6574277320456e6372797074310b300906035504031302523330820122300d06092a864886f70d01010105000382010f003082010a0282010100bb021528ccf6a094d30f12ec8d5592c3f882f199a67a4288a75d26aab52bb9c54cb1af8e6bf975c8a3d70f4794145535578c9ea8a23919f5823c42a94e6ef53bc32edb8dc0b05cf35938e7edcf69f05a0b1bbec094242587fa3771b313e71cace19befdbe43b45524596a9c153ce34c852eeb5aeed8fde6070e2a554abb66d0e97a540346b2bd3bc66eb66347cfa6b8b8f572999f830175dba726ffb81c5add286583d17c7e709bbf12bf786dcc1da715dd446e3ccad25c188bc60677566b3f118f7a25ce653ff3a88b647a5ff1318ea9809773f9d53f9cf01e5f5a6701714af63a4ff99b3939ddc53a706fe48851da169ae2575bb13cc5203f5ed51a18bdb150203010001a382010830820104300e0603551d0f0101ff040403020186301d0603551d250416301406082b0601050507030206082b0601050507030130120603551d130101ff040830060101ff020100301d0603551d0e04160414142eb317b75856cbae500940e61faf9d8b14c2c6301f0603551d2304183016801479b459e67bb6e5e40173800888c81a58f6e99b6e303206082b0601050507010104263024302206082b060105050730028616687474703a2f2f78312e692e6c656e63722e6f72672f30270603551d1f0420301e301ca01aa0188616687474703a2f2f78312e632e6c656e63722e6f72672f30220603551d20041b30193008060667810c010201300d060b2b0601040182df13010101300d06092a864886f70d01010b0500038202010085ca4e473ea3f7854485bcd56778b29863ad754d1e963d336572542d81a0eac3edf820bf5fccb77000b76e3bf65e94dee4209fa6ef8bb203e7a2b5163c91ceb4ed3902e77c258a47e6656e3f46f4d9f0ce942bee54ce12bc8c274bb8c1982fa2afcd71914a08b7c8b8237b042d08f908573e83d904330a472178098227c32ac89bb9ce5cf264c8c0be79c04f8e6d440c5e92bb2ef78b10e1e81d4429db5920ed63b921f81226949357a01d6504c10a22ae100d4397a1181f7ee0e08637b55ab1bd30bf876e2b2aff214e1b05c3f51897f05eacc3a5b86af02ebc3b33b9ee4bdeccfce4af840b863fc0554336f668e136176a8e99d1ffa540a734b7c0d063393539756ef2ba76c89302e9a94b6c17ce0c02d9bd81fb9fb768d40665b3823d7753f88e7903ad0a3107752a43d8559772c4290ef7c45d4ec8ae468430d7f2855f18a179bbe75e708b07e18693c3b98fdc6171252aafdfed255052688b92dce5d6b5e3da7dd0876c842131ae82f5fbb9abc889173de14ce5380ef6bd2bbd968114ebd5db3d20a77e59d3e2f858f95bb848cdfe5c4f1629fe1e5523afc811b08dea7c9390172ffdaca20947463ff0e9b0b7ff284d6832d6675e1e69a393b8f59d8b2f0bd25243a66f3257654d3281df3853855d7e5d6629eab8dde495b5cdb5561242cdc44ec6253844506decce005518fee94964d44eca979cb45bc073a8abb847c200000005643082056030820448a00302010202104001772137d4e942b8ee76aa3c640ab7300d06092a864886f70d01010b0500303f31243022060355040a131b4469676974616c205369676e617475726520547275737420436f2e311730150603550403130e44535420526f6f74204341205833301e170d3231303132303139313430335a170d3234303933303138313430335a304f310b300906035504061302555331293027060355040a1320496e7465726e65742053656375726974792052657365617263682047726f7570311530130603550403130c4953524720526f6f7420583130820222300d06092a864886f70d01010105000382020f003082020a0282020100ade82473f41437f39b9e2b57281c87bedcb7df38908c6e3ce657a078f775c2a2fef56a6ef6004f28dbde68866c4493b6b163fd14126bbf1fd2ea319b217ed1333cba48f5dd79dfb3b8ff12f1219a4bc18a8671694a66666c8f7e3c70bfad292206f3e4c0e680aee24b8fb7997e94039fd347977c99482353e838ae4f0a6f832ed149578c8074b6da2fd0388d7b0370211b75f2303cfa8faeddda63abeb164fc28e114b7ecf0be8ffb5772ef4b27b4ae04c12250c708d0329a0e15324ec13d9ee19bf10b34a8c3f89a36151deac870794f46371ec2ee26f5b9881e1895c34796c76ef3b906279e6dba49a2f26c5d010e10eded9108e16fbb7f7a8f7c7e50207988f360895e7e237960d36759efb0e72b11d9bbc03f94905d881dd05b42ad641e9ac0176950a0fd8dfd5bd121f352f28176cd298c1a80964776e4737baceac595e689d7f72d689c50641293e593edd26f524c911a75aa34c401f46a199b5a73a516e863b9e7d72a712057859ed3e5178150b038f8dd02f05b23e7b4a1c4b730512fcc6eae050137c439374b3ca74e78e1f0108d030d45b7136b407bac130305c48b7823b98a67d608aa2a32982ccbabd83041ba2830341a1d605f11bc2b6f0a87c863b46a8482a88dc769a76bf1f6aa53d198feb38f364dec82b0d0a28fff7dbe21542d422d0275de179fe18e77088ad4ee6d98b3ac6dd27516effbc64f533434f0203010001a382014630820142300f0603551d130101ff040530030101ff300e0603551d0f0101ff040403020106304b06082b06010505070101043f303d303b06082b06010505073002862f687474703a2f2f617070732e6964656e74727573742e636f6d2f726f6f74732f647374726f6f74636178332e703763301f0603551d23041830168014c4a7b1a47b2c71fadbe14b9075ffc4156085891030540603551d20044d304b3008060667810c010201303f060b2b0601040182df130101013030302e06082b060105050702011622687474703a2f2f6370732e726f6f742d78312e6c657473656e63727970742e6f7267303c0603551d1f043530333031a02fa02d862b687474703a2f2f63726c2e6964656e74727573742e636f6d2f445354524f4f544341583343524c2e63726c301d0603551d0e0416041479b459e67bb6e5e40173800888c81a58f6e99b6e300d06092a864886f70d01010b050003820101000a73006c966eff0e52d0aedd8ce75a06ad2fa8e38fbfc90a031550c2e56c42bb6f9bf4b44fc244880875cceb079b14626e78deec27ba395cf5a2a16e5694701053b1bbe4afd0a2c32b01d496f4c5203533f9d86136e0718db4b8b5aa824595c0f2a92328e7d6a1cb6708daa0432caa1b931fc9def5ab695d13f55b865822ca4d55e470676dc257c5463941cf8a5883586d99fe57e8360ef00e23aafd8897d0e35c0e9449b5b51735d22ebf4e85ef18e08592eb063b6c29230960dc45024c12183be9fb0ededc44f85898aeeabd4545a1885d66cafe10e96f82c811420dfbe9ece38600de9d10e338faa47db1d8e8498284069b2be86b4f010c38772ef9dde7390000
        """)

server_certificateverify_message = bytes.fromhex("""
0f0001040804010054f39599ab0a3c7a720ca54146fe4ec50fbe4ef5fb5a4463684b0ab66f81cdd5a2466934ada696064e545b3d88eea91bc736e25ff6040cadce124a2e50bee974b988c22402fbbcb38cab52e158e410d1c7ee64424d01d50562cd5d403a3d2255ec0a64683435ad4045e0f6b2561593761dd6aaf178b1dbdb48a033dc9c2346648a5911a572c1f5921a12ae7fac2e98ade7b09e171c06f79a9bccabf6f3a53797016b8d89b78258f386b879418bcb1ccf1375a318cc4782a44545d1f216fe86c5099567da47b53a9c58f3a54230dc254b0aaf7c71884bd96d6f2ab29d5d49c8a0d587598145b6721252c335172784226c2025ab73053a066aad04ef9d1f49a2fa
        """)

server_finished = bytes.fromhex("""
1400003076f8f28388cf7022d9b1f7186881c496f175c35f298f8bf94d3eef30f46eecf749152bd0e54f09b811eaf5572a751689
        """)


client_handshake_traffic_secret = bytes.fromhex("ca8fb94500b13314d4c47158b1e9c7e5d3374cf9c5703b6d8ab879e99af1529d0e013b84ae1e7b15233ff64a1ed6e06c")
finished_key = HKDF_expand_label(
    client_handshake_traffic_secret, b"finished", b"", HASH_LEN, HASH_ALG)
print(HASH_LEN)
transcript = client_hello + server_hello + \
    server_encrypted_extensions + server_certificate_message + \
    server_certificateverify_message + server_finished

client_finished = verify_data(finished_key, transcript, HASH_ALG).hex()
print(client_finished)

